<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Ragdoll House</title>
<style>
  body { margin: 0; overflow: hidden; }
  #ui {
    position: absolute;
    top: 10px;
    left: 10px;
    color: white;
    font-family: monospace;
    background: rgba(0,0,0,0.6);
    padding: 10px;
  }
</style>
</head>
<body>
<div id="ui">
WASD = Push ragdoll<br>
R = Toggle ragdoll
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>

<script>
let scene, camera, renderer, world;
let ragdoll = [];
let constraints = [];
let keys = {};

init();
animate();

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0xbfdfff);

  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
  camera.position.set(0, 5, 10);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0xffffff, 0.4));
  const light = new THREE.DirectionalLight(0xffffff, 0.8);
  light.position.set(5, 10, 5);
  scene.add(light);

  world = new CANNON.World({
    gravity: new CANNON.Vec3(0, -9.82, 0)
  });

  createHouse();
  createRagdoll();

  window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
  window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);
  window.addEventListener("resize", onResize);
}

function createStaticBox(size, pos, color = 0xaaaaaa) {
  const shape = new CANNON.Box(new CANNON.Vec3(size.x/2, size.y/2, size.z/2));
  const body = new CANNON.Body({ mass: 0, shape, position: pos });
  world.addBody(body);

  const mesh = new THREE.Mesh(
    new THREE.BoxGeometry(size.x, size.y, size.z),
    new THREE.MeshStandardMaterial({ color })
  );
  mesh.position.copy(pos);
  scene.add(mesh);
}

function createHouse() {
  // Floor
  createStaticBox({x:20,y:1,z:20}, new CANNON.Vec3(0,-0.5,0), 0x8b5a2b);

  // Outer walls
  createStaticBox({x:20,y:6,z:1}, new CANNON.Vec3(0,3,-10));
  createStaticBox({x:20,y:6,z:1}, new CANNON.Vec3(0,3,10));
  createStaticBox({x:1,y:6,z:20}, new CANNON.Vec3(-10,3,0));
  createStaticBox({x:1,y:6,z:20}, new CANNON.Vec3(10,3,0));

  // Interior walls
  createStaticBox({x:1,y:6,z:10}, new CANNON.Vec3(0,3,-5));
  createStaticBox({x:8,y:6,z:1}, new CANNON.Vec3(4,3,0));

  // Doorway sides
  createStaticBox({x:1,y:3,z:1}, new CANNON.Vec3(0,1.5,-1));
  createStaticBox({x:1,y:3,z:1}, new CANNON.Vec3(0,1.5,1));
}

function createLimb(size, pos) {
  const body = new CANNON.Body({
    mass: 1,
    shape: new CANNON.Box(new CANNON.Vec3(size.x/2,size.y/2,size.z/2)),
    position: pos
  });
  world.addBody(body);

  const mesh = new THREE.Mesh(
    new THREE.BoxGeometry(size.x,size.y,size.z),
    new THREE.MeshStandardMaterial({ color: 0xffaaaa })
  );
  scene.add(mesh);

  ragdoll.push({ body, mesh });
  return body;
}

function createRagdoll() {
  const torso = createLimb({x:1,y:1.5,z:0.5}, new CANNON.Vec3(0,5,0));
  const head = createLimb({x:0.6,y:0.6,z:0.6}, new CANNON.Vec3(0,6.5,0));
  const leg1 = createLimb({x:0.4,y:1,z:0.4}, new CANNON.Vec3(-0.4,3.5,0));
  const leg2 = createLimb({x:0.4,y:1,z:0.4}, new CANNON.Vec3(0.4,3.5,0));

  constraints.push(new CANNON.ConeTwistConstraint(torso, head));
  constraints.push(new CANNON.ConeTwistConstraint(torso, leg1));
  constraints.push(new CANNON.ConeTwistConstraint(torso, leg2));
  constraints.forEach(c => world.addConstraint(c));
}

function animate() {
  requestAnimationFrame(animate);

  // Push ragdoll
  ragdoll.forEach(p => {
    if (keys["w"]) p.body.applyForce(new CANNON.Vec3(0,0,-20));
    if (keys["s"]) p.body.applyForce(new CANNON.Vec3(0,0,20));
    if (keys["a"]) p.body.applyForce(new CANNON.Vec3(-20,0,0));
    if (keys["d"]) p.body.applyForce(new CANNON.Vec3(20,0,0));
  });

  world.step(1/60);

  ragdoll.forEach(p => {
    p.mesh.position.copy(p.body.position);
    p.mesh.quaternion.copy(p.body.quaternion);
  });

  renderer.render(scene, camera);
}

function onResize() {
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}
</script>
</body>
</html>
